---
title: "exploratory star and cast analysis"
format: html
editor: visual
---

```{r}
library(qs)
library(tidyverse)
library(ggrepel)
library(priceR)
```

# Loading Data

```{r}
data <- qread("tmdb_top50_budget_movies.qs")
cast <- qread("cast_correceted.qs")
movie_df <- qread("movie_df.qs")
```

Cast table:

```{r}
cast_df <- cast$cast_corrected
head(cast_df)
```

Movie table:

```{r}
head(movie_df)
```

# Left Join on Cast Table

We want the movie table alongside the cast table so we perform a left join.

```{r}
cast_complete <- cast_df |> 
  left_join(movie_df, by = "movie_id")
head(cast_complete)
```

## How to define stardom?

I define stardom as being the lead actor of a top ten budgeted film that had a profitable box office three times in the preceding five years.

# Star Table

Getting the leads

```{r}
leads <- cast_complete |> 
  filter(billing_order == 0)
head(leads);dim(leads)
```

Any missing data now?

```{r}
colSums(is.na(leads))
```

I want to investigate this lead table a little bit before moving forward, particularly I'm curious how often an actor leads a movie to see if the way we are defining a star makes sense. Before doing that I want to carry the movie details onto the leads table.

```{r}
top_stars <- leads |> 
  group_by(actor_name) |> 
  summarise(num_movies = n()) |> 
  slice_max(num_movies,n = 20) |> 
  pull(actor_name)
head(top_stars)
```

```{r}
leads |> 
  filter(actor_name %in% top_stars) |> 
  group_by(actor_name,year) |> 
  summarise(n = n()) |> 
  ggplot(aes(x = year, y = n, col = actor_name)) +
  geom_line()
```

I have unfortunately made the worst graph of all time, instead I will look at a rolling 5 year period for each top actor.

```{r}
star_df <- leads |> 
  filter(actor_name %in% top_stars)
head(star_df)
```

```{r}
five_year_counts <-  star_df |> 
  inner_join(star_df, by = "actor_name", suffix = c("_start","_movie")) |> 
  filter(year_movie >= year_start,
         year_movie < year_start + 5) |> 
  group_by(actor_name, year_start) |> 
  summarise(
    movies_5yr = n(),
    .groups = "drop"
  )
head(five_year_counts)

```

```{r}
typical_lead_rate <- five_year_counts |> 
  group_by(actor_name) |> 
  summarise(
    median_5yr = median(movies_5yr),
    mean_5yr = mean(movies_5yr),
    .groups = "drop"
  )
head(typical_lead_rate)
```

```{r}
ggplot(five_year_counts, aes(x = movies_5yr)) +
  geom_histogram(binwidth = 1) +
  labs(
    x = "Movies led in a 5 year window",
    y = "NUmber of actor-windows"
  )
```

```{r}
ggplot(five_year_counts, aes(x = year_start, y = movies_5yr, col = actor_name)) +
  geom_line()
```

```{r}
peaks <- five_year_counts |> 
  group_by(year_start) |> 
  slice_max(movies_5yr, n = 10, with_ties = FALSE) |> 
  ungroup()
head(peaks)
```

```{r}
ggplot(peaks, aes(x = year_start, y = movies_5yr)) +
  geom_boxplot() +
  labs(
    x = "Peak Year Start of Window",
    y = "Movies led in peak"
  )
```

```{r}
top10_by_year <- five_year_counts |> 
  group_by(year_start) |> 
  slice_max(movies_5yr, n = 10, with_ties = FALSE) |> 
  ungroup()
head(top10_by_year)
```

```{r}
ggplot(top10_by_year,
       aes(x = factor(year_start), y = movies_5yr)
       ) +
  geom_boxplot()
```

Based on this I think 3 leading roles might be a reasonable approach.
